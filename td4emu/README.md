#  TD4 エミュレータ 利用マニュアル
<!-- pandoc -f markdown -t html5 -o README.html -c github.css README.md -->

## 1. 概要

本ツールは、渡波郁氏の著書 [CPUの創りかた](https://book.mynavi.jp/ec/products/detail/id=22065) で紹介された、学習や実験を目的に設計開発された4bit CPU「TD4 (**T**ada **D**ousa-suru-dake-no)」の動作をソフトウェア上で再現するエミュレータです。  
外部ファイルからプログラム（ROMデータ）を読み込み、コンソール画面上でレジスタやフラグの状態を表示しながら実行します。

**主な機能:**

* **ステップ実行機能**: 1命令ずつ確認しながら実行可能（デバッグに最適）。
* **実行速度調整**: クロック周波数（待機時間）を任意に設定可能。
* **状態表示**: PC（プログラムカウンタ）、レジスタA/B、キャリーフラグ(C)、出力ポート(OUT)をリアルタイム表示。

## 2. 使用するTD4のバイナリ形式

本エミュレータが読み込むROMファイルは、**「テキスト形式の16進数リスト」** です。
バイナリファイル (.bin) ではなく、アセンブラが出力したHEXコードをテキストファイルとして保存したものを使用します。拡張子は、 (.hex) として下さい。 

### ファイルフォーマット仕様

* **1行につき1バイト**の命令コードを記述します。
* 値は **16進数（2桁）** で記述します（例: `30`, `F0`, `B1`）。
* 最大 **16行（16バイト）** まで読み込まれます（TD4の仕様）。
* 行の先頭に`;`があると、コメントとして無視されます。
* 空行は無視されます。

### ファイル内容の例 (`InOut.hex`)

```text
70
60
90
F0
```

## 3. コンパイル方法

ソースコード (`main.go`) を実行可能な形式にコンパイルします。

### 前提条件

* Go言語の開発環境がインストールされていること。

### 手順

ターミナル（コマンドプロンプト）を開き、ソースコードがあるディレクトリで以下のコマンドを実行します。

**Windowsの場合:**

```cmd
go build -o td4emu.exe .\main.go

```

**Mac / Linuxの場合:**

```bash
go build -o td4emu main.go

```
※ 何もエラーが表示されずに終了すればコンパイル成功です。同じフォルダに実行ファイルが生成されます。

* **Windowsの場合:** `td4emu.exe` が生成されます。
* **Mac/Linuxの場合:** `td4emu` が生成されます。

## 4. 操作方法

コマンドライン引数として「hexファイル」を指定して起動します。  
オプションを指定することで実行モードを変更できます。  

### 基本コマンド

```bash
.\td4emu.exe [オプション] <hexファイル名>

```

### オプション一覧

| オプション | 引数 | デフォルト値 | 説明 |
| --- | --- | --- | --- |
| `-step` | なし | 無効 | **ステップ実行モード**を有効にします。Enterキーを押すたびに1命令進みます。 |
| `-speed` | 秒数 | `1.0` | **通常実行時の待機時間**（秒）を指定します。値を小さくすると高速動作します。デフォルトでは、1秒に設定されています。 |



### 実行例

以下のソースコード `InOut.td4` を使用して、使用例を紹介します。
入力ポートからBレジスタに取り込んだ内容をそのまま出力ポートに送るだけのコードです。

```bash
> .\td4asm.exe -list -o InOut.hex .\InOut.td4

 ADDR      | BINARY    | HEX | SOURCE CODE
-----------|-----------|-----|----------------
 00 [0000] | 0111_0000 |  70 | MOV B, 0
 01 [0001] | 0110_0000 |  60 | IN B
 02 [0010] | 1001_0000 |  90 | OUT B
 03 [0011] | 1111_0000 |  F0 | JMP LOOP

Success! Generated 4 bytes.
Output saved to 'InOut.hex'
```

#### 画面表示の見方

実行中、コンソールには以下のようなCPUの内部状態が表示されます。

```text
PC:00 | OP:70 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?

```

* **PC** : プログラムカウンタ（現在の実行アドレス 00-15）
* **OP** : 実行中の命令コード（16進数）
* **A**  : Aレジスタの値 [2進数(10進数)]
* **B**  : Bレジスタの値 [2進数(10進数)]
* **C**  : キャリーフラグ（1=ON, 0=OFF）
* **IN** : 入力ポートの状態（物理スイッチのOnOff状態に相当）
* **OUT**: 出力ポートの状態（LEDの点灯状態に相当）

#### **1. 通常実行（1秒間隔）**

デフォルトの速度で実行します。動作確認に最適です。  
終了するには、`Ctrl+C`を入力して、強制終了して下さい。  

```bash
> .\td4emu.exe .\InOut.hex
Loaded .\InOut.hex. Starting Emulator...
Mode: Step=false, Speed=1.00s/inst
-------------------------------------------------------------
PC:00 | OP:70 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:01 | OP:60 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:02 | OP:90 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:03 | OP:F0 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:00 | OP:70 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:01 | OP:60 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:02 | OP:90 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
   ...
   ...
   ...
```

#### **2. ステップ実行（デバッグモード）**  

1命令ずつ手動で進めることができます。  
1命令実行する毎にCPU状態(レジスタやフラグ等の内容)を表示できるので、レジスタの変化を検証しながら実行したい場合に使用します。  

```bash
 .\td4emu.exe -step .\InOut.hex

```

STEP実行では、以下のコマンドが実行できます。  
表示される**？**の後に、以下のコマンドを入力して下さい。

* CR  : Enterのみを入力すると、1ステップだけ実行します。  

```bash
> .\td4emu.exe .\InOut.hex
Loaded .\InOut.hex. Starting Emulator...
Mode: Step=false, Speed=1.00s/inst
-------------------------------------------------------------
PC:00 | OP:70 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:01 | OP:60 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:02 | OP:90 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?

```

* Q   : プログラムを終了します。

```bash
> .\td4emu.exe -step .\InOut.hex
> .\td4emu.exe .\InOut.hex
Loaded .\InOut.hex. Starting Emulator...
Mode: Step=false, Speed=1.00s/inst
-------------------------------------------------------------
PC:00 | OP:70 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:01 | OP:60 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:02 | OP:90 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:03 | OP:F0 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:00 | OP:70 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:01 | OP:60 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:02 | OP:90 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ? q
program terminated !
```

* I n : 入力ポートの値を設定します。(nは、0から15までの数値)  
IN 命令の直前に、このコマンドを実行すると、設定した値がIN 命令の実行結果に反映されます。  

```bash
> .\td4emu.exe -step .\InOut.hex
Loaded .\InOut.hex. Starting Emulator...
Mode: Step=true, Speed=1.00s/inst
-------------------------------------------------------------
PC:00 | OP:70 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ? I 5
PC:01 | OP:60 | A:0000(0) B:0000(0) C:0 | IN:0101 | OUT:0000 ?
PC:02 | OP:90 | A:0000(0) B:0101(5) C:0 | IN:0101 | OUT:0000 ?
PC:03 | OP:F0 | A:0000(0) B:0101(5) C:0 | IN:0101 | OUT:0101 ?
PC:00 | OP:70 | A:0000(0) B:0101(5) C:0 | IN:0101 | OUT:0101 ?
PC:01 | OP:60 | A:0000(0) B:0000(0) C:0 | IN:0101 | OUT:0101 ? I 10
PC:02 | OP:90 | A:0000(0) B:1010(A) C:0 | IN:1010 | OUT:0101 ?
PC:03 | OP:F0 | A:0000(0) B:1010(A) C:0 | IN:1010 | OUT:1010 ?
PC:00 | OP:70 | A:0000(0) B:1010(A) C:0 | IN:1010 | OUT:1010 ? I 0b1111
PC:01 | OP:60 | A:0000(0) B:0000(0) C:0 | IN:1111 | OUT:1010 ?
PC:02 | OP:90 | A:0000(0) B:1111(F) C:0 | IN:1111 | OUT:1010 ?
PC:03 | OP:F0 | A:0000(0) B:1111(F) C:0 | IN:1111 | OUT:1111 ?
PC:00 | OP:70 | A:0000(0) B:1111(F) C:0 | IN:1111 | OUT:1111 ? q
program terminated !
```

* S n : 指定した回数だけ実行します。(nは、1以上の数値)
時間がかかる複雑な処理をステップ実行で1つ1つ動かしていくのは大変です。
この機能は、機能がわかっている処理をまとめて実行し、結果だけを見たい場合などに使います。  
以下は、複数回の加算を行い、結果をOutPortに出力するものです。

1. Aレジスタで、1+2+4+8を計算する。
2. Aレジスタの内容をBレジスタにコピーする。
3. Bレジスタの内容をOutPortに出力する。
4. 現在のアドレスにジャンプして停止状態にする。

```bash
> type .\Summation.td4
; 加算	Summation
    MOV A, 0       ; Aレジスタに 0 を代入し、初期化
    ADD A, 0b00_01 ; Aレジスタに 1 を加算( 2進数)
    ADD A, 0o02    ; Aレジスタに 2 を加算( 8進数)
    ADD A, 4       ; Aレジスタに 4 を加算(10進数)
    ADD A, 0x8     ; Aレジスタに 8 を加算(16進数)
    MOV B, A       ; Aレジスタの値をBレジスタにコピーする。
    OUT B          ; Bレジスタの値を出力ポートに送る。
STOP:
    JMP STOP ; ここで無限ループにして、停止状態にする。


> .\td4asm.exe -o .\Summation.hex -list .\Summation.td4

 ADDR      | BINARY    | HEX | SOURCE CODE
-----------|-----------|-----|----------------
 00 [0000] | 0011_0000 |  30 | MOV A, 0
 01 [0001] | 0000_0001 |  01 | ADD A, 1
 02 [0010] | 0000_0010 |  02 | ADD A, 2
 03 [0011] | 0000_0100 |  04 | ADD A, 4
 04 [0100] | 0000_1000 |  08 | ADD A, 8
 05 [0101] | 0100_0000 |  40 | MOV B, A
 06 [0110] | 1001_0000 |  90 | OUT B
 07 [0111] | 1111_0111 |  F7 | JMP STOP

Success! Generated 8 bytes.
Output saved to '.\Summation.hex'
```

以下は、その実行例です。  
2行目で、5命令分をSコマンドで実行し、結果を出力するOUT命令の部分で停止しています。  
その後は、1命令づつ実行して結果を確認しています。  

```bash
> .\td4emu.exe -step .\Summation.hex
Loaded .\Summation.hex. Starting Emulator...
Mode: Step=true, Speed=1.00s/inst
-------------------------------------------------------------
PC:00 | OP:30 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ?
PC:01 | OP:01 | A:0000(0) B:0000(0) C:0 | IN:0000 | OUT:0000 ? S 5
PC:06 | OP:90 | A:1111(F) B:1111(F) C:0 | IN:0000 | OUT:0000 ?
PC:07 | OP:F7 | A:1111(F) B:1111(F) C:0 | IN:0000 | OUT:1111 ?
PC:07 | OP:F7 | A:1111(F) B:1111(F) C:0 | IN:0000 | OUT:1111 ?
PC:07 | OP:F7 | A:1111(F) B:1111(F) C:0 | IN:0000 | OUT:1111 ? Q
program terminated !
```

#### **3. 実行速度の設定 **

デフォルトでは、1命令1秒の間隔で動作しますが、speedオプションを指定することで、高速実行させることができます。  

```bash
td4emu -speed 0.1 Sample.hex

```

## 5. 使用上の注意点と制約

1. **入力ポート（IN）の制限**
* 現在の実装では、入力ポート（IN A, IN B命令で参照される値）は初期状態では **`0000` 固定** となっています。
* ステップ実行モードでIN命令の前に、Iコマンドで入力ポートの値を設定することで、外部スイッチによる入力をシミュレートできます。

2. **16バイト制限**
* 読み込むファイルが16行を超えている場合、17行目以降のデータは無視（または切り捨て）されます。

<!--
3. **画面クリアについて**
* 多くの環境で動作させるため、画面のクリア（リフレッシュ）処理は簡易的な実装（または追記形式）となっています。長時間実行するとログが流れ続けます。


4. **未定義命令の挙動**
* TD4の仕様にない命令コード（Opcode）が含まれていた場合、エミュレータは何もしない（NOP相当）か、予期しない挙動をする可能性があります。必ずアセンブラを通した正しいコードを使用してください。
-->