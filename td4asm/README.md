# TD4 アセンブラ 利用マニュアル
<!-- pandoc -f markdown -t html5 -o README.html -c github.css README.md -->

## 1. 概要

本ツールは、渡波郁氏の著書 [CPUの創りかた](https://book.mynavi.jp/ec/products/detail/id=22065) で紹介された、学習や実験を目的に設計開発された4bit CPU「TD4 (**T**ada **D**ousa-suru-dake-no)」向けのアセンブラです。  
アセンブリ言語で記述されたソースコード(`.td4`)を読み込み、TD4の実機や別途用意しているエミュレータ(td4emu)で実行可能な機械語コード（2進数および16進数）を出力します。  

**主な特徴:**

* Go言語によるシングルバイナリ実装
* ラベル機能のサポート（ジャンプ先の自動解決）
* ソースコードと機械語の対比リスト出力
* 柔軟なフォーマット（カンマ区切り、スペース区切り、タブ区切りに対応）  
	Excelなどでデータを作ってテキストに貼り付けた場合でも問題なくアセンブルできます。

## 2. アセンブラの形式（構文）

### 行の構成

1行は以下の要素で構成されます。各要素はスペースまたはタブで区切ります。

```text
ラベル  命令  オペランド  ; コメント
```

* **ラベル**: ジャンプ先のマーカー。行頭に記述し、末尾にコロン`:`を付けることが推奨します（なくても動作します）。
* **命令**: `MOV`, `ADD` などのニーモニック。
* **オペランド**: 命令の対象となるレジスタ(`A`, `B`)や即値（数値）。カンマ`,`はあってもなくても構いません。
* **コメント**: `;` 以降は行末まで無視されます。

### サポートしている命令セット

本アセンブラは以下の命令をサポートしています。

| ニーモニック | オペランド | 解説 | 機械語 (上位4bit) |
| --- | --- | --- | --- |
| **ADD** | A, *Im* | Aレジスタに即値を加算 | `0000` |
| **ADD** | B, *Im* | Bレジスタに即値を加算 | `0101` |
| **MOV** | A, B | AレジスタにBレジスタの内容を転送 | `0001` |
| **MOV** | B, A | BレジスタにAレジスタの内容を転送 | `0100` |
| **MOV** | A, *Im* | Aレジスタに即値を代入 | `0011` |
| **MOV** | B, *Im* | Bレジスタに即値を代入 | `0111` |
| **JMP** | *Im* / *Label* | 指定アドレスへジャンプ | `1111` |
| **JNC** | *Im* / *Label* | Cフラグが0なら指定アドレスへジャンプ | `1110` |
| **IN** | A | Aレジスタに入力ポートの内容を転送 | `0010` |
| **IN** | B | Bレジスタに入力ポートの内容を転送 | `0110` |
| **OUT** | B | Bレジスタの内容を出力ポートへ転送 | `1001` |
| **OUT** | *Im* | 即値を出力ポートへ転送 | `1011` |
| **NOP** | - | 何もしない | `0000` |

* *Label*: プログラム内で定義されたラベル名
* *Im*: 即値（0～15の数値、または定義済みのラベル）

即値の整数は、以下のような表記が可能です。go言語の数値表現と同じ書式です。

- 2進数  : 0b1010,0b11_10
- 8進数  : 0o12
- 10進数 : 10
- 16進数 : 0xA

### 記述例

Summation.td4

```assembly
; 加算	Summation
    MOV A, 0       ; Aレジスタに 0 を代入し、初期化
    ADD A, 0b00_01 ; Aレジスタに 1 を加算( 2進数)
    ADD A, 0o02    ; Aレジスタに 2 を加算( 8進数)
    ADD A, 4       ; Aレジスタに 4 を加算(10進数)
    ADD A, 0x8     ; Aレジスタに 8 を加算(16進数)
    MOV B, A       ; Aレジスタの値をBレジスタにコピーする。
    OUT B          ; Bレジスタの値を出力ポートに送る。
STOP:
    JMP STOP ; ここで無限ループにして、停止状態にする。
```

## 3. コンパイル方法

本ツールはGo言語で記述されています。実行ファイルを生成するにはGoの開発環境が必要です。  
開発環境が、まだインストールされていない場合は、[Go言語公式サイト](https://go.dev/dl/)からインストーラーをダウンロードし、インストールしておいてください。  
ターミナル（WindowsならコマンドプロンプトやPowerShell、Mac/LinuxならTerminal）を開き、ソースコード(`main.go`)があるディレクトリで、以下のコマンドを入力して実行してください。  

### 手順

**Windowsの場合:**
```cmd
go build -o td4asm.exe main.go
```

**Mac / Linuxの場合:**
```bash
go build -o td4asm main.go
```

※ 何もエラーが表示されずに終了すればコンパイル成功です。同じフォルダに実行ファイルが生成されます。  

* **Windowsの場合:** `td4asm.exe` が生成されます。
* **Mac/Linuxの場合:** `td4asm` が生成されます。

## 4. 実行方法

生成された実行ファイルを使用し、アセンブリファイルを変換します。  
ここからは、**Windows** 環境での実行を例として解説します。  

### コマンド

```bash
.\td4asm.exe [オプション] <ソースファイル名>
```

### ファイル名について

* ソースコードファイルの拡張子は、(`.td4`)にして下さい。
* アセンブル結果を保存するファイルの拡張子は、(`.hex`)にして下さい。

### オプション一覧

| オプション | 引数 | デフォルト値 | 説明 |
| --- | --- | --- | --- |
| `-list` | なし | 無効 | アセンブル結果を **リスト形式** で表示します。 |
| `-dump` | なし | 無効 | アセンブル結果を **16進ダンプ形式** で表示します。 |
| `-o`    | 出力ファイル名 | なし | アセンブル結果を **16進ダンプ形式** で指定されたファイルに保存します。 |
| `-help | なし | なし | ヘルプを表示します。 |

### 実行例

以下のソースコード`Brink.td4` をアセンブルする場合:
```cmd
>type Brink.td4
; TD4 Assembly Sample: Brink
LOOP:
    MOV B, 0b0000 ; Bレジスタに即値0を格納
    OUT B         ; Bの内容を出力ポートへ (LED表示など)
    NOP           ; 時間待ち
    MOV B, 0b0001 ; Bレジスタに即値1を格納
    OUT B         ; Bの内容を出力ポートへ (LED表示など)
    NOP           ; 時間待ち
    JMP LOOP      ; 先頭のLOOPに戻る（無限ループ）
```

#### オプションなし

表示形式を指定しない場合は、アセンブルの結果のみを表示する。

```cmd
> .\td4asm.exe .\Brink.td4
Pass 1 : Ok!
Pass 2 : Ok!
Assembly completed without errors.
Code size 7 bytes.
```

#### -list リスト表示オプション

アセンブル結果をリスト形式で表示します。  
コンソールに以下のような変換リストが表示されるので、アセンブル結果の確認等にご利用下さい。  

```cmd
> .\td4asm.exe -list .\Brink.td4

 ADDR      | BINARY    | HEX | SOURCE CODE
-----------|-----------|-----|----------------
 00 [0000] | 0111_0000 |  70 | MOV B, 0b0000
 01 [0001] | 1001_0000 |  90 | OUT B
 02 [0010] | 0000_0000 |  00 | NOP
 03 [0011] | 0111_0001 |  71 | MOV B, 0b0001
 04 [0100] | 1001_0000 |  90 | OUT B
 05 [0101] | 0000_0000 |  00 | NOP
 06 [0110] | 1111_0000 |  F0 | JMP LOOP

Success! Generated 7 bytes.
```

#### -dump ダンプ表示オプション

アセンブル結果を16進数で表示します。

```bash
> .\td4asm.exe -dump .\Brink.td4
70
90
00
71
90
00
F0
```

#### -o ファイル保存オプション

アセンブル結果を16進数のHEX形式でファイルに保存します。  
このHEXファイルは、エミュレータ **td4emu** に読み込んで、実行することが可能です。  

```bash
> .\td4asm.exe -o .\Brink.hex .\Brink.td4
Output saved to '.\Brink.hex'

```

#### -help ヘルプ表示オプション

このアセンブラの使い方を表示します。

```bash
> .\td4asm.exe -help
TD4 アセンブラ
4bit CPU td4用のアセンブラです。

使い方:
td4asm [オプション] ファイル名

オプション:
  -dump
        アセンブル結果を16進数ダンプ形式で表示する
  -list
        詳細なアセンブル情報を表示する
  -o string
        アセンブル結果を16進数ダンプ形式でファイルに保存する
  -help
        このアセンブラの使用方法を表示する

使用例:
  td4asm Brink.td4                (アセンブル結果のみを出力)
  td4asm -dump Brink.td4          (DUMP形式で出力)
  td4asm -list Brink.td4          (LIST形式で出力)
  td4asm -o Brink.hex Brink.td4  (HEX形式でファイルに保存)
  td4asm -help                     (ヘルプの表示)
```

## 5. サンプルコード集

TD4の16バイト（アドレス0～15）制限の中で動作するサンプルコードです。

### **サンプル1: 往復LED（ナイトライダー風） **
LEDが左から右へ、右から左へと流れるように点灯します。TD4にはシフト命令がないため、即値転送でアニメーションを作ります。

KnightRider.td4

```assembly
; Sample 1: Knight Rider (Scanner)
; ナイトライダー :特殊装備を搭載したドリーム・カー『ナイト2000』のフロント部分の照明
; LEDが左から右へ、右から左へと流れるように点灯します。TD4にはシフト命令がないため、即値転送でアニメーションを作ります。
; 0001 -> 0010 -> 0100 -> 1000 -> 0100 -> 0010 -> Repeat

START:
    OUT 1       ; ○○○● (0001) を出力
    OUT 2       ; ○○●○ (0010) を出力
    OUT 4       ; ○●○○ (0100) を出力
    OUT 8       ; ●○○○ (1000) を出力
    OUT 4       ; ○●○○ (0100) を出力 - 折り返し
    OUT 2       ; ○○●○ (0010) を出力 - 折り返し
    JMP START   ; 最初に戻る
```

### **サンプル2: 入力加算出力（インプット・ミラー） **

入力ポート（スイッチなど）の状態を読み取り、それに1を加えた値を出力します。入力の変化がLEDに反映されます。

AddOne.td4

```assembly
; Sample 2: Input + 1 -> Output
; 入力ポートの値に1を足して出力し続ける

LOOP:
    IN A        ; 入力ポートの値をAレジスタに読み込む
    ADD A, 1    ; Aに1を加算する
    MOV B, A    ; 出力するためBへ転送
    OUT B       ; 出力ポートへ出す
    JMP LOOP    ; 繰り返し

```

### **サンプル3: カウントダウンタイマー **

LEDを全て点灯（1111）させた状態からスタートし、徐々にカウントダウンして0になったら点滅して知らせます。
※ `SUB`（引き算）命令がないため、「15を加算する（＝1引くのと同じ）」ことで減算を実現しています（オーバーフローを利用）。

Timer.td4

```assembly
; Sample 3: Countdown Timer
; 15から0までカウントダウンし、0になったら点滅

START:
    MOV A, 15    ; カウンタ初期値 1111

COUNT_DOWN:
    MOV B, A     ; 表示用にBへ
    OUT B        ; 現在のカウントを表示
    ADD A, 15    ; 15を足す＝1引くのと同じ (例: 2+15=17->1)
    JNC FINISH   ; キャリーが出ない＝0からさらに引いた瞬間 なので終了へ
    JMP COUNT_DOWN

FINISH:
    ; 終了時の点滅演出
    OUT 15       ; 全点灯
    OUT 0        ; 全消灯
    JMP FINISH   ; ここで無限ループ（点滅が早すぎる場合はWaitが必要だが容量不足）
```

## 6. 使用上の注意点と制約

1. **レジスタ間演算は不可**
* TD4のハードウェア仕様上、`ADD A, B` や `ADD B, A` といった「レジスタ同士の加算」はできません。
* 加算命令は `ADD A, 数値` または `ADD B, 数値` のみ有効です。

2. **OUT命令の制約**
* OUT命令が使用できるのは、Bレジスタのみです。
* `OUT A` （Aレジスタの内容を出力）という命令は存在しません。
* レジスタの値を出力したい場合は、一度Bレジスタに転送してから `OUT B` を使用してください。

3. **即値の範囲**
* 4bit CPUであるため、即値（Im）として指定できる数値は **0 ～ 15** (0x0 ～ 0xF) の範囲に限られます。

4. **プログラムサイズ**
* 標準的なTD4のROM容量は16バイト（アドレス 0～15）です。
* 本アセンブラは16行以上のコードも変換可能ですが、実機や標準的なエミュレータでは動作しない可能性があります。

5. **大文字・小文字**
* 命令（`MOV`, `mov`）やレジスタ名（`A`, `a`）は大文字小文字を区別しません（内部で自動的に大文字として扱われます）。
